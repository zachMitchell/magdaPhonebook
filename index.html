<!DOCTYPE html>
<html>
    <body>
        <input type='file' id='contactListIn'>

        <div id='editorField'></div>
        <div id="previewField"></div>

        <script>
            var categories = {

            }

            /*These are sorted to be relocated through the DOM. they are independent from categories.
            Syntax: Zachary Mitchell = "zm0". If there's another contact with the same first and last name letters, the number will be incremented (e.g zm1)
            There will also be an integer system to keep track of instances of names, for example, let's say there's a key of zm. 
                this will be an integer that will say what the next index for that combination will be.
            */
            var contactObjects = {

            }

            var newContacts = 0;
            var loadedContacts = 0;
            var contactList = [];
            contactListIn.onchange = function(){
                newContacts = 0;
                loadedContacts = 0;
                for(var i of contactListIn.files) i.text().then(e=>{
                    newContacts++;
                    if(newContacts == contactListIn.files.length){
                        //Start parsing!
                        // console.log(e);
                        parseContactFile(e);
                        loadedContacts++;
                        if(loadedContacts == newContacts){
                            //Everything loaded, let's display it!
                            for(var i in categories){
                                if(typeof categories[i] == 'object'){
                                    console.log(categories[i],i);
                                    editorField.appendChild(categories[i].inDom);
                                    previewField.appendChild(categories[i].outDom);
                                }
                            }
                        }
                    }
                });
            }

            //Parse the custom file format for this program, or a vcf. Only need to grab the neccessary values.
            function parseContactFile(strIn){
                //Default to blank category until we find a new category to use:
                if(categories[''] == undefined) new category(); //Yes, this is referencable :o
                var blankCategory = categories[0];

                //Figure out if this is a vcf:
                var fname = lname = number = ''; //heheheheheh
                if(strIn.indexOf('BEGIN:VCARD') > -1){
                    //parse vcf

                }
                else{
                    //parse custom file format
                    var currentCategory = new category();
                    for(var i of strIn.split('\n')){
                        if(i[0] == ')'){
                            //Sort contacts and create a new category:
                            currentCategory.refreshContacts();

                            //Grab information:
                            var info = i.substring(1).split(',');
                            //Make the new category
                            currentCategory = new category(...info);
                        }
                        //Assume a contact otherwise:
                        else{
                            currentCategory.contacts.push(new contact(...(i.split(',')) ));
                            console.log(currentCategory.contacts[currentCategory.contacts.length-1]);
                        }
                    }
                    currentCategory.refreshContacts();
                }
            }

            //Both of these objects have DOM elements tied to them:
            //Contact object - contains basic information including name and phone.
            function contact(fname='',lname='',number=''){

                //Initialize dom elements:
                this.inDom = document.createElement('div');
                this.inDom.innerHTML='<input placeholder="First Name" class="fname"><input placeholder="Last Name" class="lname"><input placeholder="Phone Number" class="number"> <br>';
                this.outDom = document.createElement('div');
                this.outDom.innerHTML = '<h2><span class="ofname"></span> <span class="olname"></span></h2><h3 class="onumber"></h3><br>';

                //Set one of the primary avaiable variables: first name, last name, and number
                this.setAttribute = function (target,value){
                    //If value is something else, convert to string:
                    value = ''+value;
                    var allowedAttributes = ['fname','lname','number'];
                    if(allowedAttributes.indexOf(target) > -1){
                        var finalVal = '';
                        //Since there's allot of things to filter out, parsing will be manual here:
                        for(var i = 0;i<value.length;i++){
                            //If this is a phone number, take out anything that's not a number
                            if(target!='number' || target == 'number' && !isNaN(value[i]))
                                if( (i>0 && value[i]!=',') || (i == 0 && '|),'.indexOf(value[i]) ==-1)) //Remove custom file-type syntax if that slips in.
                                    finalVal+=value[i];
                        }

                        //set internal value and dom elements:
                        this[target] = finalVal;
                        this.inDom.getElementsByClassName(target)[0].value = finalVal;
                        if(target == 'number'){
                            //Numbers will work differently then other values. In the element, the value will be stored alongside a formatted one.
                            var outSpan = this.outDom.getElementsByClassName('o'+target)[0]

                            if(finalVal.length > 10)
                                outSpan.innerHTML = "("+finalVal.substring(0,3)+ ") " + finalVal.substring(3);
                            else if(finalVal.length == 10)
                                outSpan.innerHTML = "("+finalVal.substring(0,3)+ ") " + finalVal.substring(3,6) + " - " + finalVal.substring(6);
                            else if (finalVal.length == 7)
                                outSpan.innerHTML = finalVal.substring(0,3) + " - " + finalVal.substring(3);
                            else outSpan.innerHTML = finalVal;

                            outSpan.dataset.value = finalVal;
                        }
                        else this.outDom.getElementsByClassName('o'+target)[0].innerHTML = finalVal;

                        return finalVal;
                    }
                    else console.error('The function can only accept the following: '+allowedAttributes.join(', ')+'.');
                }

                //Core Attributes (Please do not set directly)
                this.setAttribute('fname',fname);
                this.setAttribute('lname',lname);
                this.setAttribute('number',number);

                // console.log(fname,lname,number);
                //Permanent ID of this contact. Will not change unless the page is refreshed / contact is deleted.
                this.contactObjId = this.fname[0] + '' + this.lname[0];
                console.log(this.contactObjId)
                //Define integer index if it doesn't exist:
                if(contactObjects[this.contactObjId] === undefined) contactObjects[this.contactObjId] = 0;
                //Increment integer index by one:
                contactObjects[this.contactObjId]++;
                this.contactObjId+=contactObjects[this.contactObjId]-1;
                //From here on out we're not referencing the integer index, we're referencing this object.
                contactObjects[this.contactObjId] = this;

                //(inDom) Add event listeners and contact object ID:
                for(var i of this.inDom.getElementsByTagName('input')){
                    i.dataset.contactObjId = this.contactObjId;
                    i.onchange = function(){
                        contactObjects[this.dataset.contactObjId].setAttribute(this.className,this.value);
                    }
                }
            }

            //Category - contains information such as section color, font, and current contacts.
            function category(name='',font='',color='#000000'){
                this.inDom = document.createElement('div');
                //the div tag on the end of this next variable is where the list of contacts will go (or at least their associated DOM element.)
                this.inDom.innerHTML = '<span class="catContainer"><input class="catName"><input type="color" class="catColor"><input class="catFont"></input></span><div class="catContacts"></div>';
                this.outDom = document.createElement('div');
                this.outDom.innerHTML = '<h1 class="catHeader"></h1><div class="outCatContacts"></div>';
                this.setAttribute = function(target,value){
                    if(['name','color','font'].indexOf(target) > -1){
                        value = ''+value;
                        //ommit anything that could trip the custom file format:
                        var finalVal = '';
                        for(var i = 0;i<value.length;i++)
                            //Go through the parse dance again
                            if( (i>0 && value[i]!=',') || (i == 0 && '|),'.indexOf(value[i]) ==-1))
                                finalVal+=value[i];

                        this[target] = finalVal;
                        this.inDom.getElementsByClassName('cat'+target[0].toUpperCase()+target.substring(1))[0].value=finalVal;
                        //Output:
                        switch(target){
                            case 'name': this.outDom.getElementsByClassName('catHeader')[0].innerHTML = finalVal;
                            break;
                            case 'color': this.outDom.style.color = finalVal;
                            break;
                            case 'font': this.outDom.style.fontFamily = finalVal;
                        }
                    }
                    else console.error('The function only accepts the following: name, color, font.');
                }

                //Sort contacts by first name or last name, then re-insert elements into the system:
                //If there's a huge amount of contacts in the list, you can optionally not sort at all and just add ones not in the DOM yet.
                this.refreshContacts = function(sort = true,firstLast = true){
                    var resultInElement = this.inDom.getElementsByClassName('catContacts')[0];
                    var resultOutElement = this.outDom.getElementsByClassName('outCatContacts')[0];
                    if(sort){
                        resultInElement.innerHTML = "";
                        resultOutElement.innerHTML = "";
                        //sort by first name or last name:
                        var sortBy = (firstLast?'f':'l')+'name';
                        for(var i = 0;i<this.contacts.length;i++){
                            for(var j=0;j<this.contacts.length;j++){
                                if(this.contacts[j][sortBy] > this.contacts[i][sortBy]){
                                    var temp = this.contacts[i];
                                    this.contacts[i] = this.contacts[j];
                                    this.contacts[j] = temp;
                                }
                            }
                        }

                        //print elements to the respective dom elements:
                        for(var i of this.contacts){
                            //Input dom
                            resultInElement.appendChild(i.inDom);
                            //Output dom
                            resultOutElement.appendChild(i.outDom);
                        }


                    }
                    else{
                        //Simply compare the size differences and add the most recent elements to the dom:
                        if(this.contacts.length > resultInElement.children.length){
                            var lengthCount = 0;
                            for(var i = 0;resultInElement.children.length < this.contacts.length;i++)
                                resultInElement.appendChild(this.contacts[resultInElement.children.length+i].inDom);                                
                        }
                    }
                }

                this.setAttribute('name',name);
                this.setAttribute('font',font);
                this.setAttribute('color',color);
                this.contacts = [];
                //The id system of categories will be a little different. (This needs to be set before name is set...)
                this.catId = this.name[0];
                if(categories[this.catId] == undefined) categories[this.catId] = 0;
                //Indcrement the base id
                categories[this.catId]++;
                this.catId+=categories[this.catId]-1;
                //Referencing this object now (...yes it's confusing XP):
                categories[this.catId] = this;

                //Insert this new id into the required elements (Also add event listeners):
                for(var i of this.inDom.getElementsByClassName('catContainer')[0].children){
                    i.dataset.catId = this.catId;
                    i.onchange = function(){
                        categories[this.dataset.catId].setAttribute(this.className.substring(3).toLowerCase(),this.value)
                    }
                }
            }
        </script>
    </body>
</html>