<!DOCTYPE html>
<html>
    <head>
        <style>
        .categoryDiv:hover .newContactBtn{
            visibility: visible;
        }
        .categoryDiv .newContactBtn{
            visibility: hidden;
        }
        .contactDiv:hover .conDelBtn{
            visibility: visible;
        }
        .contactDiv .conDelBtn{
            visibility: hidden;
        }
        </style>
    </head>
    <body>
        <input type='file' id='contactListIn'>

        <div id='editorField'></div>
        <div id="previewField"></div>

        <script src="objects.js"></script>
        <script>
            var newContacts = 0;
            var loadedContacts = 0;
            var contactList = [];
            contactListIn.onchange = function(){
                newContacts = 0;
                loadedContacts = 0;
                for(var i of contactListIn.files) i.text().then(e=>{
                    newContacts++;
                    if(newContacts == contactListIn.files.length){
                        //Start parsing!
                        // console.log(e);
                        parseContactFile(e);
                        loadedContacts++;
                        if(loadedContacts == newContacts){
                            //Everything loaded, let's display it!
                            for(var i in categories){
                                if(typeof categories[i] == 'object'){
                                    // console.log(categories[i],i);
                                    editorField.appendChild(categories[i].inDom);
                                    previewField.appendChild(categories[i].outDom);
                                }
                            }
                        }
                    }
                });
            }

            //Parse the custom file format for this program, or a vcf. Only need to grab the neccessary values.
            function parseContactFile(strIn){
                //Default to blank category until we find a new category to use:
                if(categories[''] == undefined) new category(); //Yes, this is referencable :o
                var blankCategory = categories[0];

                //Figure out if this is a vcf:
                if(strIn.indexOf('BEGIN:VCARD') > -1){
                    //parse vcf

                }
                else{
                    //parse custom file format
                    var currentCategory = categories[0];
                    for(var i of strIn.split('\n')){
                        if(i[0] == ')'){
                            //Sort contacts and create a new category:
                            currentCategory.refreshContacts();

                            //Grab information:
                            var info = i.substring(1).split(',');
                            //Make the new category, also make sure we don't do a duplicate category name:
                            currentCategory = catQuery(info[0]);
                            if(!currentCategory) currentCategory = new category(...info);
                            else{
                                //Since this is later in the file, attributes will be updated here
                                currentCategory.setAttribute('font',info[1]);
                                currentCategory.setAttribute('color',info[2]);
                            }
                        }
                        //Assume a contact otherwise:
                        else currentCategory.contacts.push(new contact(...(i.split(',')) ));
                    }
                    currentCategory.refreshContacts();
                }
            }
            
            //Quick and dirty method to find a category of the same name. Not super perfect... since names can be disassociated with their id's, but fair enough for it's purpose.
            function catQuery(name=''){
                var keys = Object.keys(categories).filter(e=>e[0] == name[0]);
                for(var i in keys)
                    if(typeof(categories[keys[i]]) == 'object' && categories[keys[i]].name == name) return categories[keys[i]];
            }
        </script>
    </body>
</html>