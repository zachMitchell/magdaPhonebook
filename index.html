<!DOCTYPE html>
<html>
    <head>
        <style>
        .categoryDiv:hover .newContactBtn,
        .contactDiv:hover .conDelBtn,
        .categoryDiv:hover .delCatBtn{
            visibility: visible;
        }
        .categoryDiv .newContactBtn,
        .contactDiv .conDelBtn,
        .categoryDiv .delCatBtn{
            visibility: hidden;
        }

        #previewField{
            border-top:2px dashed skyblue;
            margin-top:10px
        }
        </style>
    </head>
    <body>
        <input type='file' id='contactListIn'><button onclick='confirm("Start over from scratch? Everything will need to be re-assembled!")?domInterface.clearEverything():0'>Clear Phonebook</button>

        <div id='editorField'></div>
        <div id='newCatInterface'>
            <span style='display:none'><input placeholder="Category Name"/><input placeholder="Font"/><input type='color' placeholder="Color"/><button onclick="domInterface.addCatBtn(this)">Add!</button></span>
            <button onclick='domInterface.newCatToggle(this)'>Add New Category</button>
        </div>
        <div id="previewField"></div>

        <script src="objects.js"></script>
        <script>
            var newContacts = 0;
            var loadedContacts = 0;
            var contactList = [];
            contactListIn.onchange = function(){
                newContacts = 0;
                loadedContacts = 0;
                var fReader = new FileReader();
                
                fReader.onload = e=>{
                    newContacts++;
                    if(newContacts == contactListIn.files.length){
                        //Start parsing!
                        // console.log(e);
                        parseContactFile(e.srcElement.result);
                        loadedContacts++;
                        if(loadedContacts == newContacts){
                            //Everything's loaded, let's display it!
                            for(var i of domInterface.sortCategories()){
                                // console.log(categories[i],i);
                                editorField.appendChild(i.inDom);
                                previewField.appendChild(i.outDom);
                            }
                        }
                    }
                }

                for(var i of contactListIn.files) fReader.readAsText(i);
            }

            //Parse the custom file format for this program, or a vcf. Only need to grab the neccessary values.
            function parseContactFile(strIn){
                //Default to blank category until we find a new category to use:
                if(categories[''] == undefined) new category(); //Yes, this is referencable :o
                var blankCategory = categories[0];

                //Figure out if this is a vcf:
                if(strIn.indexOf('BEGIN:VCARD') > -1){
                    //parse vcf

                }
                else{
                    //parse custom file format
                    var currentCategory = categories[0];
                    for(var i of strIn.split('\n')){
                        if(i[0] == ')'){
                            //Sort contacts and create a new category:
                            currentCategory.refreshContacts();

                            //Grab information:
                            var info = i.substring(1).split(',');
                            //Make the new category, also make sure we don't do a duplicate category name:
                            currentCategory = catQuery(info[0]);
                            if(!currentCategory) currentCategory = new category(...info);
                            else{
                                //Since this is later in the file, attributes will be updated here
                                currentCategory.setAttribute('font',info[1]);
                                currentCategory.setAttribute('color',info[2]);
                            }
                        }
                        //Assume a contact otherwise:
                        else currentCategory.contacts.push(new contact(...(i.split(',')) ));
                    }
                    currentCategory.refreshContacts();
                }
            }
            
            //Quick and dirty method to find a category of the same name. Not super perfect... since names can be disassociated with their id's, but fair enough for it's purpose.
            function catQuery(name=''){
                //The isNaN part here is for detecting names with a blank address (numerical indexes)
                var keys = Object.keys(categories).filter(e=>(e[0] == name[0]) || !isNaN(e) && name === '');
                for(var i in keys)
                    if(typeof(categories[keys[i]]) == 'object' && categories[keys[i]].name === name) return categories[keys[i]];
            }
            
            var domInterface = {
                //Oh snap, you clicked THAT button! :O CHAOS IS UPON US!! (nooooo)
                clearEverything: function(){
                    editorField.innerHTML = previewField.innerHTML = '';
                    newContacts = loadedContacts = 0;
                    contactList = [];
                    categories = {}, contactObjects = {};
                    contactListIn.value = '';
                    domInterface.addNewCategory();
                    //I guess it was just a dream... see you, Ness!
                },
                //Grab all category keys and sort by name
                sortCategories: ()=>Object.values(categories).filter(e=>typeof e == 'object').sort((e,f)=>e.name > f.name?1:-1),
                newCatToggle:e=>{
                    //Check to see if the container is hidden
                    var container = e.parentElement.children[0];
                    var addCancel = container.style.display == 'none';
                    e.innerHTML = addCancel?'Cancel':'Add New Category';
                    container.style.display = addCancel?'':'none';
                },
                addCatBtn:e=>{
                    //Collect information from dom.
                    var containerInputs = e.parentElement.getElementsByTagName('input');
                    var inputData = [];
                    //Clean up the dom for next use and close the interface
                    for(var i of containerInputs){
                        inputData.push(i.value);
                        i.value = i.type == 'color'?'#000000':'';
                    }
                    domInterface.newCatToggle(newCatInterface.children[1]);
                    //Actually add the button:
                    domInterface.addNewCategory(...inputData);
                },
                addNewCategory:function(name,color,font){
                    var addedCat = new category(...arguments);
                    editorField.innerHTML = previewField.innerHTML = '';
                    for(var i of domInterface.sortCategories()){
                        editorField.appendChild(i.inDom);
                        previewField.appendChild(i.outDom);
                    }
                }

            }

            domInterface.addNewCategory();
        </script>
    </body>
</html>